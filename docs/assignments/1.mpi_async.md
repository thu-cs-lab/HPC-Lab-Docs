# 小作业一：MPI 异步通信

负责助教：翟明书 zhaims22@mails.tsinghua.edu.cn

## 背景

在课堂上，我们学习了 MPI 的点对点通信原语。其中， `MPI_Send` 和 `MPI_Recv` 为阻塞式通信，`MPI_Isend` 和 `MPI_Irecv` 为非阻塞式通信。非阻塞通信提供了 计算-通信 重叠的可能性。

本次作业提供的程序模拟了 计算-通信 循环出现的场景。通过动手测试，你将体会到 计算-通信 重叠带来的性能提升。

## 任务

实验文件在集群上的位置为 `/home/course/hpc/assignments/2023/exp1` 。

首先将实验文件 **拷贝到自己的目录** ，并进入 `exp1` 目录：

```bash
cp -R /home/course/hpc/assignments/2023/exp1 ~/
cd ~/exp1/
```

本次作业提供了 `mpi_sync.cpp` 和 `mpi_async.cpp` 两份代码，分别使用阻塞/非阻塞通信原语模拟了 计算-通信 循环出现的场景。使用以下方式编译程序：

```bash
spack load openmpi
make
```

应当得到与下面类似的输出：

```text
mpicxx mpi_sync.cpp -O3 -std=c++11 -o mpi_sync
mpicxx mpi_async.cpp -O3 -std=c++11 -o mpi_async
```

编译得到的 `mpi_sync` 和 `mpi_async` 程序有三个输入参数，分别代表 运行轮数、每次通信消息的长度、每次的计算量。

我们将运行轮数固定为 `10`。

在消息长度较短的时候，可能性能会有波动，助教在批改时会考虑到此问题。

### 任务一：通信时间测试

本任务的运行脚本为 `task1.sh` 。使用命令 `./task1.sh` 运行。

在任务一中，我们将使用 `mpi_sync` 程序测试不同长度消息的通信耗时。具体而言，你需要补全以下表格：

| 编号 | 消息长度 | 计算量 (ms) | 总耗时 (ms) |
| ---- | -------- | ------ | ------ |
| 1    | 16384    | 0      |        |
| 2    | 32768    | 0      |        |
| 3    | 65536    | 0      |        |
| 4    | 131072   | 0      |        |
| 5    | 262144   | 0      |        |
| 6    | 524288   | 0      |        |
| 7    | 1048576  | 0      |        |
| 8    | 2097152  | 0      |        |
| 9    | 4194304  | 0      |        |
| 10   | 8388608  | 0      |        |
| 11   | 16777216 | 0      |        |
| 12   | 33554432 | 0      |        |

并回答问题：

- 每次消息长度是倍增的，总耗时的变化趋势是如何的？
- 为什么会有这样的趋势？

### 任务二：阻塞与非阻塞的对比

本任务的运行脚本为 `task2.sh` 。使用命令 `./task2.sh` 运行。

在任务二中，我们将使用 `mpi_sync` 和 `mpi_async` 程序来对比两种通信模式的性能。具体而言，你需要补全以下表格：

| 编号 | 消息长度  | 计算量 (ms) | mpi_sync 总耗时 (ms) | mpi_async 总耗时 (ms) |
| ---- | --------- | ------ | --------------- | ----------------- |
| 1    | 100000000 | 10     |                 |                   |
| 2    | 100000000 | 20     |                 |                   |
| 3    | 100000000 | 40     |                 |                   |
| 4    | 100000000 | 80     |                 |                   |
| 5    | 100000000 | 160    |                 |                   |

并回答问题：

- 通信时间和计算时间满足什么关系时，非阻塞通信程序能完美掩盖通信时间？
- 简述两份代码的不同之处。

## 实验提交

此实验仅需提交实验报告，请在下发的 `report.md` 模板中填写内容，并将 **PDF 文件** 提交至网络学堂。
